<div class="client-ui" data-current-user-building="<%= current_user.building_id %>">
  <div id="loader" style="display: none;"></div>
  <% if current_user.building.docks? && !@channel.private? %>
    <%= button_to posts_path, remote: true, class: "btn open-profil", method: :get do %>
      <span class="candy_red_bg">NOUVEAU</span>
      Voir les profils des Docks
      </span>
    <% end %>
  <% end %>
  <div class="scroll-container">
    <div class="row">
      <div class="messages-container">
        <div class="infos-channel">
          <% if @channel.private? %>
            <%= render "buildings/templates/private_channel_info" %>
          <% elsif @channel.group? %>
            <%= render "buildings/templates/group_channel_info" %>
          <% end %>
        </div>

        <% @messages.order(created_at: :asc).each do |message| %>
          <div class="message-wrapper">
            <%= render "messages/message", message: message %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  <div class="col-channels">
    <%= render "buildings/templates/col_channels" %>
  </div>
  <div class="modal-bg hidden"></div>
  <%= render "messages/footer" %>
</div>

<%= render layout: "layouts/modal", locals: { modal_name: "new-message", modal_size: "", modal_title: "" } do %>
  <div class="user-infos text-center">
    <div class="user-icon space-2">
      <%= image_tag (""), class: "member-image" %>
    </div>
    <span class="user-name">Michael</span>
    <%= simple_form_for [@building, Channel.new] do |f| %>
      <%= f.hidden_field :recipient_id %>
      <%= f.hidden_field :channel_type, value: "private" %>
      <%= f.hidden_field :building_id, value: @building.id %>
      <%= button_tag "Envoyer un message privé", class: "btn btn-secondary space-top-2" %>
    <% end %>
  </div>
<% end %>

<%= render layout: "layouts/modal", locals: { modal_name: "notification", modal_size: "", modal_title: "Veuillez sélectionner les conversations pour recevoir les notifications par email" } do %>
  <div class="">
    <% current_user.user_channels_group.each do |user_channel| %>
      <%= simple_form_for user_channel, remote: true, data: { autosubmit: true } do |f| %>
        <%= f.input :want_notification, input_html: { id: "user_channel_#{user_channel.id}" }, label: "#{user_channel.channel.name}"  %>
      <% end %>
    <% end %>
    <div class="text-center">
      <button type="button" class="btn btn-secondary btn-lg" data-dismiss="modal" aria-label="Close"><span>Enregistrer et fermer</span></button>
    </div>
  </div>
<% end %>


<%= render "buildings/templates/votes_modal" %>
<%= render "users/edit_profil_modal" %>
<%= render "posts/new_post_modal" %>
<%= render "posts/post_card_modal" %>
<%= render "channels/new_channel_modal" %>

<div class="modal fade upload-dialog" id="new-photo_modal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span>&times;</span></button>
        <p class="modal-title">Télécharger une image ?</span></p>
      </div>
      <div class="modal-body">
      <div id="upload_image_preview" class="space-2">
        <%= image_tag ("") %> <br>
        <div class="title"></div>
      </div>
      <label class="space-top-2">Votre message <span class="hint">(Optionnel)</span> </label>
      <div class="body-form form-group">
        <%= text_area :message, :body, class: "form-control", id: "body-from-file" %>
      </div>
      <div class="text-right">
        <%= button_tag "Envoyer", class: "btn btn-secondary new-photo" %>
        <%= button_tag "Annuler", class: "btn btn-secondary-outline ", data: { dismiss: "modal" } %>
      </div>
    </div>
  </div>
</div>

<!-- Algolia -->

<script>
  $('#user_name').autocomplete({ hint: false }, [
    {
      source: $.fn.autocomplete.sources.hits(index, { hitsPerPage: 10 }),
      displayKey: 'first_name',
      templates: {
        suggestion: function(suggestion) {
          alreadySelected = $('.selection .aa-suggestion [data-user-for-channel=' + suggestion.id + ']').length > 0
          if ( suggestion.building_id == $('[data-current-user-building]').data('current-user-building') && !alreadySelected ) {
            if ( suggestion.photo_url.toString().match(/cloudinary/) ) {
              photoUrl = suggestion.photo_url
            }
            else {
              obj = new(imageUrlGenerator)
              photoUrl = obj.generate(suggestion.photo_url)
            }
            return '<img src="' + photoUrl + '">' + suggestion.first_name + " " + suggestion.last_name + '<span data-user-for-channel="' + suggestion.id + '" class="hidden"></span>'
          }
          else {
            return '<span class="to-remove"></span>'
          }
        }
      }
    }
  ]).on('autocomplete:updated', function(event, suggestion, dataset) {
    $('.to-remove').closest('.aa-suggestion').remove()
  }).on('autocomplete:selected', function(event, suggestion, dataset) {
    user = $('.aa-suggestions .aa-suggestion.aa-cursor').clone()
    user.append('<i class="fa fa-times remove-user"></i>')
    user.prependTo($('.selection'))
    $(".remove-user").on("click", function() {
      id = $(this).siblings('[data-user-for-channel]').data('user-for-channel')
      $('.selection .aa-suggestion [data-user-for-channel=' + id + ']').remove();
      $(this).closest('.aa-suggestion.aa-cursor').remove();
    });
    $('#user_name').val("")
  });
</script>

